						[ESTRUCTURA DE TERRALINK]
Solucion en blanco
|
| 
   |1. Presentación
	|asp_presentaciones [Aplicación web de ASP.Net Core (Razor Pages)]
		|Cosas importantes (Program.cs y Startup.cs, Carpeta "Pages")
		-- Paginas razor donde está la estética y los cshtml y cshtml.cs, además se hace la inyección de dependencias.
	|lib_presentaciones [Biblioteca de Clases]
		|Cosas importantes (Carpetas "Implementaciones" e "Interfaces" y Comunicaciones.cs)
		 -- Se contruye la URL, se comunica el fronted con el backend o los servicios con ayuda de la llave y se continua
		     con el filtro de búsqueda.
   |2. Servicios
	|asp_servicios [ASP.Net Core Web API]
		|Cosas importantes (Carpetas "Controllers" e "Nucleo", Startup.cs y Program.cs) => tokencontroller es la llave
		    -- se hace la inyección de dependencias, y se controla las peticiones de los servicios y se pone una llave, no aplica JWT.
		       usa HTTP (Sobre todo método Post)
	|lib_repositorios [Biblioteca de Clases]
		|Cosas importantes (Carpetas "Implementaciones" e "Interfaces" y "Migrations")
		-- funciones que realiza CRUD y se pone un "filtro de busqueda" todo con EntityFramework.SqlServer
   |3. Núcleo
	|lib_dominio [Biblioteca de Clases]
		|Cosas importantes (Carpetas "Entidades" y "Nucleo") 
		  -- en entidades se ponen las clases y en nucleo se pone lo relacionado con json, conversión, encriptado, enumerables, etc.
		      usa Newton.Json 
   |4. Pruebas Unitarias (No es tan "Importante" por ahora)
   |Elementos de la solución
	secrets.json
__________________________________________________________________________________________________________________________
//Comunicaciones.cs

using lib_dominio.Nucleo;

namespace lib_presentaciones
{
    public class Comunicaciones
    {
        private string? URL = string.Empty,
            llave = null;

        public Comunicaciones(string url = "http://localhost:5175/")
        {
            URL = url;
        }

        public Dictionary<string, object> ConstruirUrl(Dictionary<string, object> data, string Metodo)
        {
            data["Url"] = URL + Metodo;
            data["UrlLlave"] = URL + "Token/Llave";
            return data;
        }

        public async Task<Dictionary<string, object>> Ejecutar(Dictionary<string, object> datos)
        {
            var respuesta = new Dictionary<string, object>();
            try
            {
                respuesta = await Llave(datos);
                if (respuesta == null || respuesta.ContainsKey("Error"))
                    return respuesta!;
                respuesta.Clear();

                if (string.IsNullOrEmpty(llave))
                {
                    respuesta.Add("Error", "lbErrorComunicacion");
                    return respuesta;
                }

                var url = datos["Url"].ToString();
                datos.Remove("Url");
                datos.Remove("UrlLlave");
                datos["Llave"] = llave!;
                var stringData = JsonConversor.ConvertirAString(datos);

                var httpClient = new HttpClient();
                httpClient.Timeout = new TimeSpan(0, 4, 0);
                var message = await httpClient.PostAsync(url, new StringContent(stringData));
                if (!message.IsSuccessStatusCode)
                {
                    respuesta.Add("Error", "lbErrorComunicacion");
                    return respuesta;
                }

                var resp = await message.Content.ReadAsStringAsync();
                httpClient.Dispose(); httpClient = null;
                if (string.IsNullOrEmpty(resp))
                {
                    respuesta.Add("Error", "lbErrorComunicacion");
                    return respuesta;
                }

                resp = Replace(resp);
                respuesta = JsonConversor.ConvertirAObjeto(resp);
                return respuesta;
            }
            catch (Exception ex)
            {
                respuesta["Error"] = ex.ToString();
                return respuesta;
            }
        }

        private async Task<Dictionary<string, object>> Llave(Dictionary<string, object> datos)
        {
            var respuesta = new Dictionary<string, object>();
            try
            {
                var url = datos["UrlLlave"].ToString();
                var temp = new Dictionary<string, object>();
                temp["Entidad"] = new Dictionary<string, object>()
                {
                    { "NombreUsuario", "Pepito@email.com" },
                    { "Clave", "JHGjkhtu6387456yssdf" }
                };
                var stringData = JsonConversor.ConvertirAString(temp);

                var httpClient = new HttpClient();
                httpClient.Timeout = new TimeSpan(0, 1, 0);
                var mensaje = await httpClient.PostAsync(url, new StringContent(stringData));
                if (!mensaje.IsSuccessStatusCode)
                {
                    respuesta.Add("Error", "lbErrorComunicacion");
                    return respuesta;
                }

                var resp = await mensaje.Content.ReadAsStringAsync();
                httpClient.Dispose(); httpClient = null;
                if (string.IsNullOrEmpty(resp))
                {
                    respuesta.Add("Error", "lbErrorComunicacion");
                    return respuesta;
                }

                resp = Replace(resp);
                respuesta = JsonConversor.ConvertirAObjeto(resp);
                llave = respuesta["Llave"].ToString();
                return respuesta;
            }
            catch (Exception ex)
            {
                respuesta["Error"] = ex.ToString();
                return respuesta;
            }
        }

        private string Replace(string resp)
        {
            return resp.Replace("\\\\r\\\\n", "")
            .Replace("\\r\\n", "")
            .Replace("\\", "")
            .Replace("\\\"", "\"")
            .Replace("\"", "'")
            .Replace("'[", "[")
            .Replace("]'", "]")
            .Replace("'{'", "{'")
            .Replace("\\\\", "\\")
            .Replace("'}'", "'}")
            .Replace("}'", "}")
            .Replace("\\n", "")
            .Replace("\\r", "")
            .Replace(" ", "")
            .Replace("'{", "{")
            .Replace("\"", "")
            .Replace(" ", "")
            .Replace("null", "''");
        }
    }
}
__________________________________________________________________________________________________________________________
//TokenAplicacion.cs

using lib_dominio.Entidades;
using lib_repositorios.Interfaces;

namespace lib_repositorios.Implementaciones
{
    public class TokenAplicacion
    {
        private IConexion? IConexion = null;
        // El profe dice mejore las llaves
        private string llave = "KJGjkhdjkfgkjf54fs65d4f65sd4f";

        public TokenAplicacion(IConexion iConexion)
        {
            this.IConexion = iConexion;
        }

        public void Configurar(string StringConexion)
        {
            this.IConexion!.StringConexion = StringConexion;
        }

        public string Llave(Usuarios? entidad)
        {
            var usuario = this.IConexion!.Usuarios!
                .FirstOrDefault(x => x.NombreUsuario == entidad!.NombreUsuario && 
                                x.Clave == entidad.Clave);
            if (usuario == null)
                return string.Empty;
            return llave;
        }

        public bool Validar(Dictionary<string, object> datos)
        {
            if (!datos.ContainsKey("Llave"))
                return false;
            if (string.IsNullOrEmpty(datos["Llave"].ToString()))
                return false;
            return this.llave == datos["Llave"].ToString();
        }
    }
}
_________________________________________________________________________________________________________________________
//TokenController.cs
using asp_servicios.Nucleo;
using lib_dominio.Entidades;
using lib_dominio.Nucleo;
using Microsoft.AspNetCore.Mvc;
using lib_repositorios.Implementaciones;

namespace asp_servicios.Controllers
{
    [ApiController]
    [Route("[controller]/[action]")]
    public class TokenController : ControllerBase
    {
        private TokenAplicacion? iAplicacion = null;

        public TokenController(TokenAplicacion? iAplicacion)
        {
            this.iAplicacion = iAplicacion;
        }

        private Dictionary<string, object> ObtenerDatos()
        {
            var datos = new StreamReader(Request.Body).ReadToEnd().ToString();
            if (string.IsNullOrEmpty(datos))
                datos = "{}";
            return JsonConversor.ConvertirAObjeto(datos);
        }

        [HttpPost]
        public string Llave()
        {
            var respuesta = new Dictionary<string, object>();
            try
            {
                var datos = ObtenerDatos();
                this.iAplicacion!.Configurar(Configuracion.ObtenerValor("StringConexion"));

                var entidad = JsonConversor.ConvertirAObjeto<Usuarios>(
                    JsonConversor.ConvertirAString(datos["Entidad"]));
                respuesta["Llave"] = this.iAplicacion!.Llave(entidad);
                respuesta["Respuesta"] = "OK";
                respuesta["Fecha"] = DateTime.Now.ToString();
                return JsonConversor.ConvertirAString(respuesta);
            }
            catch (Exception ex)
            {
                respuesta["Error"] = ex.Message.ToString();
                respuesta["Respuesta"] = "Error";
                return JsonConversor.ConvertirAString(respuesta);
            }
        }

        public bool Validate(Dictionary<string, object> datos)
        {
            try
            {
                this.iAplicacion!.Configurar(Configuracion.ObtenerValor("StringConexion"));
                return this.iAplicacion!.Validar(datos);
            }
            catch
            {
                return false;
            }
        }
    }

}
__________________________________________________________________________________________________________________________
//DatosGenerales.cs

namespace lib_dominio.Nucleo
{
    public class DatosGenerales
    {
        // Ruta donde se encuentra el archivo JSON con las credenciales
        public static string ruta_json = @"C:\Users\USUARIO\OneDrive\Desktop\TerraLink_X\secrets.json";
        public static bool usa_azure = false;
        public static string clave = "EVBgi345936456ghhVBJGtgnifytsidi3456678jhgUTytutyiiyi";
        public static string usuario_datos = EncriptarConversor.Encriptar("Test.Trghhjsgdj");
    }
}

